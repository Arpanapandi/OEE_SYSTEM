@model OeeSystem.Models.ViewModels.MachineOeeViewModel
@{
    ViewData["Title"] = "OEE Detail - " + Model.MachineName;
    var shiftDateStr = Model.ShiftDate.ToString("yyyy-MM-dd");
    var shiftStartStr = Model.ShiftStart.ToString("HH:mm");
    var shiftEndStr = Model.ShiftEnd.ToString("HH:mm");
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="fa-solid fa-microchip me-2"></i>@Model.MachineName
        </h2>
        <div class="text-secondary small">
            <i class="fa-solid fa-layer-group me-1"></i>@Model.LineId
            <span class="ms-3">
                <i class="fa-solid fa-calendar-day me-1"></i>@(string.IsNullOrEmpty(Model.ShiftName) ? $"Shift {Model.ShiftCode}" : Model.ShiftName) (@shiftStartStr - @shiftEndStr)
            </span>
            <span class="ms-3">
                <i class="fa-solid fa-clock me-1"></i>Standar Cycle Time Product: @Model.StandarCycleTime.ToString("F1")s
            </span>
        </div>
    </div>
    <div>
        @{
            var statusClass = Model.Status switch
            {
                OeeSystem.Models.MachineStatus.Aktif => "status-running",
                OeeSystem.Models.MachineStatus.TidakAktif => "status-down",
                _ => "status-idle"
            };
            var statusText = Model.Status == OeeSystem.Models.MachineStatus.Aktif ? "Aktif" : "Tidak Aktif";
        }
        <span class="status-badge @statusClass">@statusText</span>
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary btn-sm ms-2">
            <i class="fa-solid fa-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>
</div>

<div id="shift-meta"
     data-shift-key="@Model.ShiftKey"
     data-shift-date="@shiftDateStr"
     data-shift-code="@Model.ShiftCode"
     data-shift-id="@(Model.ShiftId?.ToString() ?? "")"></div>

<!-- Machine Actions Section - Compact with Inline Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center" style="padding: 0.75rem 1rem;">
                <div>
                    <i class="fa-solid fa-sliders me-2"></i>Machine Actions
                </div>
                <div>
                    <span class="badge @(Model.MachineStatus == MachineStatus.Aktif ? "bg-success" : "bg-warning")" id="machine-status-badge">
                        @(Model.MachineStatus == MachineStatus.Aktif ? "AKTIF" : "TIDAK AKTIF")
                    </span>
                    @if (Model.MachineStatus == MachineStatus.TidakAktif)
                    {
                        <span class="small text-warning ms-2" id="machine-status-info">
                            <i class="fa-solid fa-exclamation-triangle me-1"></i>Machine di-set Tidak Aktif di Admin
                        </span>
                    }
                    else if (Model.HasActiveDowntime && !string.IsNullOrEmpty(Model.ActiveDowntimeDescription))
                    {
                        <span class="small text-danger ms-2" id="downtime-description">
                            @Model.ActiveDowntimeDescription
                        </span>
                    }
                </div>
            </div>
            <div class="card-body" style="padding: 1rem;">
                <!-- Action Buttons - Compact Horizontal Layout -->
                <div class="row g-2">
                    <!-- RUNNING PROCESS Button -->
                    <div class="col-md-3 col-6">
                        <form asp-controller="Operator" asp-action="Start" method="post" id="running-form" style="margin: 0;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="machineId" value="@Model.MachineId" />
                            <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
                            <button type="submit" 
                                    id="btn-running" 
                                    class="btn btn-sm w-100 btn-outline-success"
                                    style="pointer-events: auto !important; cursor: pointer !important;"
                                    @(Model.MachineStatus == MachineStatus.TidakAktif || (Model.HasActiveJob && !Model.HasActiveDowntime) ? "disabled" : "")>
                                <i class="fa-solid fa-play-circle me-1"></i>
                                RUNNING
                            </button>
                        </form>
                    </div>

                    <!-- REST BREAK Button -->
                    @if (Model.RestReason != null)
                    {
                        <div class="col-md-3 col-6">
                            <form asp-controller="Operator" asp-action="Rest" method="post" id="rest-form" style="margin: 0;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="machineId" value="@Model.MachineId" />
                                <input type="hidden" name="reasonId" value="@Model.RestReason.Id" />
                                <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
                                <button type="submit" 
                                        id="btn-rest" 
                                        class="btn btn-sm w-100 btn-outline-warning"
                                        style="pointer-events: auto !important; cursor: pointer !important;"
                                        @(Model.MachineStatus == MachineStatus.TidakAktif || (Model.HasActiveJob && !Model.HasActiveDowntime) ? "disabled" : "")>
                                    <i class="fa-solid fa-pause-circle me-1"></i>
                                    REST BREAK
                                </button>
                            </form>
                        </div>
                    }

                    <!-- LINE STOP Button -->
                    <div class="col-md-3 col-6">
                        <button type="button" 
                                id="btn-line-stop" 
                                class="btn btn-sm w-100 btn-outline-danger"
                                style="pointer-events: auto !important; cursor: pointer !important;"
                                data-bs-toggle="modal" 
                                data-bs-target="#lineStopModal"
                                @(Model.MachineStatus == MachineStatus.TidakAktif || (Model.HasActiveJob && !Model.HasActiveDowntime) ? "disabled" : "")>
                            <i class="fa-solid fa-stop-circle me-1"></i>
                            LINE STOP
                        </button>
                    </div>

                    <!-- TAMBAH QTY Button -->
                    <div class="col-md-3 col-6">
                        <button type="button" 
                                class="btn btn-sm w-100 btn-primary" 
                                data-bs-toggle="modal" 
                                data-bs-target="#addQtyModal">
                            <i class="fa-solid fa-plus-circle me-1"></i>
                            QUANTITY
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OEE KPI Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card kpi-card border-primary" style="margin-bottom: 0;">
            <div class="card-body" style="padding: 1.25rem;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-secondary small mb-1">OEE</div>
                        <div class="kpi-value text-primary">@Model.Oee.ToString("F1")%</div>
                    </div>
                    <i class="fa-solid fa-chart-line fa-2x text-primary opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card border-success" style="margin-bottom: 0;">
            <div class="card-body" style="padding: 1.25rem;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-secondary small mb-1">Availability</div>
                        <div class="kpi-value text-success">@Model.Availability.ToString("F1")%</div>
                    </div>
                    <i class="fa-solid fa-clock fa-2x text-success opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card border-warning" style="margin-bottom: 0;">
            <div class="card-body" style="padding: 1.25rem;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-secondary small mb-1">Performance</div>
                        <div class="kpi-value text-warning">@Model.Performance.ToString("F1")%</div>
                    </div>
                    <i class="fa-solid fa-gauge-high fa-2x text-warning opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card border-info" style="margin-bottom: 0;">
            <div class="card-body" style="padding: 1.25rem;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-secondary small mb-1">Quality</div>
                        <div class="kpi-value text-info">@Model.Quality.ToString("F1")%</div>
                    </div>
                    <i class="fa-solid fa-check-circle fa-2x text-info opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Time Metrics -->
    <div class="col-md-3">
        <div class="card h-100" style="margin-bottom: 0;">
            <div class="card-header" style="padding: 1rem 1.25rem;">
                <i class="fa-solid fa-clock me-2"></i>Time Metrics
            </div>
            <div class="card-body d-flex flex-column" style="padding: 1.25rem;">
                <div class="mb-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-secondary">Planned Production</span>
                        <span class="fw-semibold" id="planned-production-time">@Model.PlannedProductionTime.ToString(@"hh\:mm\:ss")</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-primary" style="width: 100%"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-secondary">Operating Time</span>
                        <span class="fw-semibold text-success" id="operating-time">@Model.OperatingTime.ToString(@"hh\:mm\:ss")</span>
                    </div>
                    <div class="progress" style="height: 6px; background-color: #e9ecef;">
                        @{
                            var operatingPercent = Model.PlannedProductionTime.TotalSeconds > 0 
                                ? (Model.OperatingTime.TotalSeconds / Model.PlannedProductionTime.TotalSeconds * 100) 
                                : 0;
                            
                            // Logika warna dinamis: Hijau >=80%, Kuning 50-80%, Merah <50%
                            string operatingColor;
                            if (operatingPercent >= 80)
                            {
                                operatingColor = "#28a745";
                            }
                            else if (operatingPercent >= 50)
                            {
                                operatingColor = "#ffc107";
                            }
                            else
                            {
                                operatingColor = "#dc3545";
                            }
                        }
                        <div class="progress-bar" id="operating-progress-bar" style="width: @operatingPercent.ToString("F1")%; background-color: @operatingColor !important; min-width: 2px;"></div>
                    </div>
                </div>
                <div class="mt-auto">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-secondary">Downtime</span>
                        <span class="fw-semibold text-danger" id="downtime-total">@Model.DowntimeTotal.ToString(@"hh\:mm\:ss")</span>
                    </div>
                    <div class="progress" style="height: 6px; background-color: #e9ecef;">
                        @{
                            var downtimePercent = Model.PlannedProductionTime.TotalSeconds > 0 
                                ? (Model.DowntimeTotal.TotalSeconds / Model.PlannedProductionTime.TotalSeconds * 100) 
                                : 0;
                            
                            // Logika warna dinamis: Merah >20%, Kuning 10-20%, Hijau <10%
                            string downtimeColor;
                            if (downtimePercent > 20)
                            {
                                downtimeColor = "#dc3545";
                            }
                            else if (downtimePercent > 10)
                            {
                                downtimeColor = "#ffc107";
                            }
                            else
                            {
                                downtimeColor = "#28a745";
                            }
                        }
                        <div class="progress-bar" id="downtime-progress-bar" style="width: @downtimePercent.ToString("F1")%; background-color: @downtimeColor !important; min-width: 2px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Production Metrics -->
    <div class="col-md-3">
        <div class="card h-100" style="margin-bottom: 0;">
            <div class="card-header" style="padding: 1rem 1.25rem;">
                <i class="fa-solid fa-boxes me-2"></i>Production Metrics
            </div>
            <div class="card-body d-flex flex-column" style="padding: 1.25rem;">
                <div class="mb-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-primary">
                            <i class="fa-solid fa-box me-1"></i>Total Produced
                        </span>
                        <span class="fw-semibold text-primary">@Model.TotalCount</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-primary" style="width: 100%"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fw-semibold" style="color: #28a745 !important;">
                            <i class="fa-solid fa-check-circle me-1"></i>Good
                        </span>
                        <span class="fw-bold" style="color: #28a745 !important;">@Model.GoodCount</span>
                    </div>
                    <div class="progress" style="height: 8px; background-color: #e9ecef;">
                        @{
                            var goodPercent = Model.TotalCount > 0 ? (Model.GoodCount * 100.0 / Model.TotalCount) : 0;
                            
                            // Logika warna dinamis: Hijau >=95%, Kuning 80-95%, Merah <80%
                            string goodColor;
                            if (goodPercent >= 95)
                            {
                                goodColor = "#28a745";
                            }
                            else if (goodPercent >= 80)
                            {
                                goodColor = "#ffc107";
                            }
                            else
                            {
                                goodColor = "#dc3545";
                            }
                        }
                        <div class="progress-bar" id="good-progress-bar" style="width: @goodPercent.ToString("F1")%; background-color: @goodColor !important; min-width: 2px;"></div>
                    </div>
                </div>
                <div class="mt-auto">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fw-semibold" style="color: #dc3545 !important;">
                            <i class="fa-solid fa-times-circle me-1"></i>Reject
                        </span>
                        <span class="fw-bold" style="color: #dc3545 !important;">@Model.RejectCount</span>
                    </div>
                    <div class="progress" style="height: 8px; background-color: #e9ecef;">
                        @{
                            var rejectPercent = Model.TotalCount > 0 ? (Model.RejectCount * 100.0 / Model.TotalCount) : 0;
                            
                            // Logika warna dinamis: Merah >5%, Kuning 2-5%, Hijau <2%
                            string rejectColor;
                            if (rejectPercent > 5)
                            {
                                rejectColor = "#dc3545";
                            }
                            else if (rejectPercent > 2)
                            {
                                rejectColor = "#ffc107";
                            }
                            else
                            {
                                rejectColor = "#28a745";
                            }
                        }
                        <div class="progress-bar" id="reject-progress-bar" style="width: @rejectPercent.ToString("F1")%; background-color: @rejectColor !important; min-width: 2px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Job -->
    <div class="col-md-6">
        <div class="card h-100" style="margin-bottom: 0;">
            <div class="card-header" style="padding: 1rem 1.25rem;">
                <i class="fa-solid fa-clipboard-list me-2"></i>Current Job
            </div>
            <div class="card-body d-flex flex-column" style="padding: 1.25rem;">
                @if (Model.ActiveJob != null)
                {
                    <div class="row g-2 h-100">
                        <!-- Left Section: Product Image/Name -->
                        <div class="col-5 d-flex flex-column">
                            <div class="mb-2">
                                @if (!string.IsNullOrEmpty(Model.ActiveJob.ProductImageUrl))
                                {
                                    <img src="@Model.ActiveJob.ProductImageUrl" alt="@(Model.ActiveJob?.ProductName ?? "Product")" 
                                         class="img-fluid rounded mb-2" style="max-height: 200px; max-width: 100%; width: auto; height: auto; object-fit: contain;" />
                                }
                                else
                                {
                                    <div class="text-center mb-2" style="min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-secondary">@Model.ActiveJob.ProductName</span>
                                    </div>
                                }
                            </div>
                            <div class="mt-auto">
                                <div class="fw-semibold small">@(Model.ActiveJob?.ProductName ?? "Unknown Product")</div>
                                <div class="text-secondary small">@(Model.ActiveJob?.WorkOrderNumber ?? "-")</div>
                            </div>
                        </div>
                        
                        <!-- Right Section: Progress & Info -->
                        <div class="col-7 d-flex flex-column">
                            <div class="mb-2">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>Progress</span>
                                    <span id="progress-text">@Model.GoodCount / @(Model.ActiveJob?.TargetQuantity ?? 0)</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    @{
                                        var targetQty = Model.ActiveJob?.TargetQuantity ?? 0;
                                        var progressPercent = targetQty > 0 
                                            ? (Model.GoodCount * 100.0 / targetQty) 
                                            : 0;
                                        if (progressPercent > 100) progressPercent = 100;
                                    }
                                    <div id="progress-bar" class="progress-bar bg-primary" role="progressbar" style="width: @progressPercent.ToString("F1")%;" aria-valuenow="@progressPercent" aria-valuemin="0" aria-valuemax="100">
                                        <span id="progress-percent" class="small">@progressPercent.ToString("F1")%</span>
                                    </div>
                                </div>
                                <div class="small mt-1 text-secondary">
                                    Total Good: <span id="total-good" class="fw-bold text-success">@Model.GoodCount</span> • 
                                    Reject: <span id="total-reject" class="fw-bold text-danger">@Model.RejectCount</span>
                                </div>
                                @if ((Model.ActiveJob?.TargetQuantity ?? 0) > 0)
                                {
                                    <div class="small mt-1 text-info">
                                        <i class="fa-solid fa-clock me-1"></i>
                                        Est. Completion: <span id="estimated-completion">@(ViewData["EstimatedCompletion"] ?? "-")</span>
                                    </div>
                                }
                            </div>
                            <div class="mt-auto">
                                <div class="small text-secondary mb-2">
                                    <div class="mb-1"><i class="fa-solid fa-user me-1"></i>Operator: @(Model.ActiveJob?.OperatorName ?? "Unknown")</div>
                                    <div class="mb-1"><i class="fa-solid fa-play me-1"></i>Started: @(Model.ActiveJob?.StartTime.ToString("MM/dd HH:mm") ?? "-")</div>
                                </div>
                                <!-- Durasi sejak status terakhir - Prominent -->
                                <div class="pt-2 border-top">
                                    <div class="text-secondary small mb-1">Durasi sejak status terakhir</div>
                                    <div class="fs-4 fw-bold text-primary" id="since-last-status">
                                        @{
                                            var sinceLastChangeSeconds = Model.ActiveJob?.SinceLastChangeSeconds ?? 0;
                                            var sinceLastChange = TimeSpan.FromSeconds(sinceLastChangeSeconds);
                                        }
                                        @sinceLastChange.ToString(@"hh\:mm\:ss")
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="text-center text-secondary py-5 my-auto">
                        <i class="fa-solid fa-inbox fa-3x mb-3 opacity-50"></i>
                        <div class="fw-semibold">No active job</div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

    <!-- Modal Line Stop -->
    <div class="modal fade" id="lineStopModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">LINE STOP - Pilih Alasan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form asp-controller="Operator" asp-action="LineStop" method="post" id="line-stop-start-form">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="machineId" value="@Model.MachineId" />
                    <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Pilih Alasan Line Stop:</label>
                            <select class="form-select" name="reasonId" required>
                                <option value="">-- Pilih Alasan --</option>
                                @foreach (var r in Model.LineStopReasons)
                                {
                                    <option value="@r.Id">@r.Description (@r.Category)</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fa-solid fa-play me-2"></i>START LINE STOP
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Qty -->
    <div class="modal fade" id="addQtyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Output</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form asp-controller="Operator" asp-action="AddQuantity" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="machineId" value="@Model.MachineId" />
                    <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Good Qty</label>
                            <input type="number" class="form-control" name="goodQty" value="0" min="0" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reject Qty</label>
                            <input type="number" class="form-control" name="rejectQty" value="0" min="0" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jenis NG (jika ada reject)</label>
                            <select class="form-select" name="ngTypeId">
                                <option value="">-- Pilih Jenis NG --</option>
                                @foreach (var ng in Model.NgTypes)
                                {
                                    <option value="@ng.Id">@ng.Code - @ng.Name</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Alasan Reject (optional)</label>
                            <input type="text" class="form-control" name="rejectReason" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<div class="row g-4 mb-4">
    <!-- Recent Downtimes -->
    <div class="col-md-6">
        <div class="card" style="margin-bottom: 0;">
            <div class="card-header" style="padding: 1rem 1.25rem;">
                <i class="fa-solid fa-triangle-exclamation me-2"></i>Recent Downtimes
            </div>
            <div class="card-body" style="padding: 1.25rem;">
                @if (Model.RecentDowntimes != null && Model.RecentDowntimes.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Reason</th>
                                    <th>Start</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var dt in Model.RecentDowntimes)
                                {
                                    <tr>
                                        <td>
                                            <div class="small">@(dt.ReasonDescription ?? "-")</div>
                                            <div class="text-secondary" style="font-size: 0.7rem;">@(dt.ReasonCategory ?? "-")</div>
                                        </td>
                                        <td class="small">@dt.StartTime.ToString("MM/dd HH:mm")</td>
                                        <td>
                                            @if (dt.EndTime.HasValue)
                                            {
                                                <span class="text-success">@TimeSpan.FromSeconds(dt.DurationSeconds).ToString(@"hh\:mm\:ss")</span>
                                            }
                                            else
                                            {
                                                <span class="text-danger">Ongoing</span>
                                            }
                                        </td>
                                        <td>
                                            @if (dt.EndTime.HasValue)
                                            {
                                                <span class="badge bg-success">Closed</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Active</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center text-secondary py-3">
                        <i class="fa-solid fa-check-circle fa-2x mb-2"></i>
                        <div>No downtime recorded</div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Recent Production Counts -->
    <div class="col-md-6">
        <div class="card" style="margin-bottom: 0;">
            <div class="card-header" style="padding: 1rem 1.25rem;">
                <i class="fa-solid fa-chart-column me-2"></i>Recent Production Counts
            </div>
            <div class="card-body" style="padding: 1.25rem;">
                @if (Model.RecentProductionCounts != null && Model.RecentProductionCounts.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th class="text-end">Good</th>
                                    <th class="text-end">Reject</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var pc in Model.RecentProductionCounts)
                                {
                                    <tr>
                                        <td class="small">@pc.Timestamp.ToString("MM/dd HH:mm")</td>
                                        <td class="text-end text-success">@(pc.GoodCount)</td>
                                        <td class="text-end text-danger">@(pc.RejectCount)</td>
                                        <td class="small text-secondary">@(pc.RejectReason ?? "-")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center text-secondary py-3">
                        <i class="fa-solid fa-inbox fa-2x mb-2"></i>
                        <div>No production counts</div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row g-4 mb-4">
    <!-- Machine Run Time Donut Chart -->
    <div class="col-md-4">
        <div class="card" style="margin-bottom: 0;">
            <div class="card-header" style="padding: 1rem 1.25rem;">
                <i class="fa-solid fa-clock me-2"></i>Machine Run Time (min)
            </div>
            <div class="card-body" style="padding: 1.25rem;">
                <canvas id="runTimeDonutChart" style="max-height: 300px;"></canvas>
                <div class="text-center mt-3">
                    <div class="fw-bold">Total @((Model.ChartData?.RunTimeMinutes ?? 0) + (Model.ChartData?.IdleTimeMinutes ?? 0) + (Model.ChartData?.OffTimeMinutes ?? 0))</div>
                </div>
            </div>
        </div>
    </div>

    <!-- OEE Analysis Bar Chart -->
    <div class="col-md-4">
        <div class="card" style="margin-bottom: 0;">
            <div class="card-header" style="padding: 1rem 1.25rem;">
                <i class="fa-solid fa-chart-bar me-2"></i>OEE Analysis
            </div>
            <div class="card-body" style="padding: 1.25rem;">
                <canvas id="oeeBarChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Machine Operation Trend -->
    <div class="col-md-4">
        <div class="card" style="margin-bottom: 0;">
            <div class="card-header" style="padding: 1rem 1.25rem;">
                <i class="fa-solid fa-chart-line me-2"></i>Machine Operation Trend
            </div>
            <div class="card-body" style="padding: 1.25rem;">
                <canvas id="weeklyTrendChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>

<style>
    /* Progress bar colors dinamis - warna akan diatur berdasarkan data proses mesin */
    /* Operating Time: Hijau >=80%, Kuning 50-80%, Merah <50% */
    /* Downtime: Merah >20%, Kuning 10-20%, Hijau <10% */
    /* Good: Hijau >=95%, Kuning 80-95%, Merah <80% */
    /* Reject: Merah >5%, Kuning 2-5%, Hijau <2% */
    
    /* Pastikan progress bar memiliki min-width untuk visibility */
    #operating-progress-bar,
    #downtime-progress-bar,
    #good-progress-bar,
    #reject-progress-bar {
        min-width: 2px;
        transition: background-color 0.3s ease;
    }
</style>

@section Scripts {
    <script>
        // Donut Chart: Machine Run Time
        const runTimeCtx = document.getElementById('runTimeDonutChart').getContext('2d');
        new Chart(runTimeCtx, {
            type: 'doughnut',
            data: {
                labels: ['Run Time', 'Idle Time', 'Off Time'],
                datasets: [{
                    data: [
                        @(Model.ChartData?.RunTimeMinutes ?? 0),
                        @(Model.ChartData?.IdleTimeMinutes ?? 0),
                        @(Model.ChartData?.OffTimeMinutes ?? 0)
                    ],
                    backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#e4e6eb',
                            padding: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + ' min';
                            }
                        }
                    }
                }
            }
        });

        // Bar Chart: OEE Analysis
        const oeeBarCtx = document.getElementById('oeeBarChart').getContext('2d');
        new Chart(oeeBarCtx, {
            type: 'bar',
            data: {
                labels: ['OEE', 'Availability', 'Performance', 'Quality'],
                datasets: [{
                    label: 'Percentage (%)',
                    data: [
                        @(Model.ChartData?.OeeValue ?? 0),
                        @(Model.ChartData?.AvailabilityValue ?? 0),
                        @(Model.ChartData?.PerformanceValue ?? 0),
                        @(Model.ChartData?.QualityValue ?? 0)
                    ],
                    backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#06b6d4'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            color: '#9ca3af',
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: {
                            color: '#23293a'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });

        // Stacked Bar Chart: Weekly Trend
        const weeklyTrendCtx = document.getElementById('weeklyTrendChart').getContext('2d');
        const weeklyLabels = [@Html.Raw(Model.ChartData?.WeeklyTrend != null ? string.Join(", ", Model.ChartData.WeeklyTrend.Select(t => $"'{t.DateLabel}'")) : "")];
        const weeklyRunTime = [@Html.Raw(Model.ChartData?.WeeklyTrend != null ? string.Join(", ", Model.ChartData.WeeklyTrend.Select(t => t.RunTimeMinutes.ToString("F0"))) : "")];
        const weeklyIdleTime = [@Html.Raw(Model.ChartData?.WeeklyTrend != null ? string.Join(", ", Model.ChartData.WeeklyTrend.Select(t => t.IdleTimeMinutes.ToString("F0"))) : "")];
        const weeklyOffTime = [@Html.Raw(Model.ChartData?.WeeklyTrend != null ? string.Join(", ", Model.ChartData.WeeklyTrend.Select(t => t.OffTimeMinutes.ToString("F0"))) : "")];

        new Chart(weeklyTrendCtx, {
            type: 'bar',
            data: {
                labels: weeklyLabels,
                datasets: [
                    {
                        label: 'Run Time',
                        data: weeklyRunTime,
                        backgroundColor: '#3b82f6',
                        borderWidth: 0
                    },
                    {
                        label: 'Idle Time',
                        data: weeklyIdleTime,
                        backgroundColor: '#22c55e',
                        borderWidth: 0
                    },
                    {
                        label: 'Off Time',
                        data: weeklyOffTime,
                        backgroundColor: '#ef4444',
                        borderWidth: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            color: '#9ca3af',
                            callback: function(value) {
                                return value + ' min';
                            }
                        },
                        grid: {
                            color: '#23293a'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#e4e6eb',
                            padding: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + ' min';
                            }
                        }
                    }
                }
            }
        });
    </script>

    <script>
        // ========== REAL-TIME TIME METRICS UPDATE ==========
        const machineId = '@Model.MachineId';
        let timeMetricsInterval = null;
        let realTimeCounter = 0; // Counter yang bertambah setiap detik
        let basePlannedSeconds = @Model.PlannedProductionTime.TotalSeconds;
        let baseOperatingSeconds = @Model.OperatingTime.TotalSeconds;
        let baseDowntimeSeconds = @Model.DowntimeTotal.TotalSeconds;
        const shiftMetaEl = document.getElementById('shift-meta');
        const shiftDate = shiftMetaEl?.dataset.shiftDate || '';
        const shiftCode = shiftMetaEl?.dataset.shiftCode || '';
        const shiftId = shiftMetaEl?.dataset.shiftId || '';
        let lastShiftKey = shiftMetaEl?.dataset.shiftKey || '';

        // Format seconds to HH:mm:ss
        function formatTime(seconds) {
            // Handle NaN, undefined, or invalid values
            if (isNaN(seconds) || seconds === null || seconds === undefined) {
                return "00:00:00";
            }
            
            // Ensure seconds is a valid number
            seconds = Math.max(0, Math.floor(Number(seconds)));
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Start real-time counter
        function startTimeCounter() {
            // Clear existing interval
            if (timeMetricsInterval) {
                clearInterval(timeMetricsInterval);
                timeMetricsInterval = null;
            }

            // Update every second - PASTIKAN selalu dipanggil
            timeMetricsInterval = setInterval(() => {
                try {
                    realTimeCounter++; // Increment counter setiap detik
                    updateTimeDisplay(); // Update display setiap detik
                } catch (error) {
                    console.error('❌ Error in real-time counter:', error);
                }
            }, 1000);
            
            console.log('✅ Real-time counter started - akan update setiap detik');
            console.log('⏱️ Interval ID:', timeMetricsInterval);
            
            // Verify interval is running
            setTimeout(() => {
                if (timeMetricsInterval) {
                    console.log('✅ Real-time counter verified - running correctly');
                } else {
                    console.error('❌ Real-time counter failed to start!');
                }
            }, 2000);
        }

        // Store active job/downtime info - Initialize dari server-side data
        let hasActiveJob = @(Model.ActiveJob != null ? "true" : "false");
        @{
            var hasActiveDowntimeValue = Model.RecentDowntimes != null && Model.RecentDowntimes.Any(d => !d.EndTime.HasValue);
        }
        let hasActiveDowntime = @(hasActiveDowntimeValue ? "true" : "false");
        let previousHasActiveJob = hasActiveJob;
        let previousHasActiveDowntime = hasActiveDowntime;

        // Fetch time metrics from server
        function fetchTimeMetrics() {
            const params = new URLSearchParams({
                id: machineId
            });
            if (shiftId) {
                params.append('shiftId', shiftId);
            }
            if (shiftDate) {
                params.append('shiftDate', shiftDate);
            }
            if (shiftCode) {
                params.append('shiftCode', shiftCode);
            }

            return fetch(`/Machine/GetTimeMetrics?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const newShiftKey = data.ShiftKey || '';
                    // Store active job/downtime info
                    const newHasActiveJob = data.HasActiveJob || false;
                    const newHasActiveDowntime = data.HasActiveDowntime || false;

                    // Update base values dengan nilai baru dari server (sudah termasuk waktu saat fetch)
                    basePlannedSeconds = Number(data.PlannedProductionTimeSeconds) || 0;
                    baseOperatingSeconds = Number(data.OperatingTimeSeconds) || 0;
                    baseDowntimeSeconds = Number(data.DowntimeTotalSeconds) || 0;

                    // Jika shift berubah, reset counter dan simpan shiftKey baru
                    const shiftChanged = newShiftKey && newShiftKey !== lastShiftKey;
                    if (shiftChanged) {
                        lastShiftKey = newShiftKey;
                    }

                    // Reset counter karena base sudah mengandung waktu terkini
                    realTimeCounter = 0;

                    // Update status
                    hasActiveJob = newHasActiveJob;
                    hasActiveDowntime = newHasActiveDowntime;
                    previousHasActiveJob = hasActiveJob;
                    previousHasActiveDowntime = hasActiveDowntime;

                    // Update display immediately
                    updateTimeDisplay();
                    
                    // ✅ PERUBAHAN: Update durasi sejak status terakhir menggunakan SinceLastChangeSeconds (sama seperti Operator View)
                    if (data.SinceLastChangeSeconds !== undefined && data.SinceLastChangeSeconds !== null) {
                        updateSinceLastChange(data.SinceLastChangeSeconds);
                    } else if (data.LastStatusChangeTime) {
                        // Fallback untuk backward compatibility
                        const lastChangeTime = new Date(data.LastStatusChangeTime);
                        const now = new Date();
                        const diffSeconds = Math.floor((now.getTime() - lastChangeTime.getTime()) / 1000);
                        updateSinceLastChange(diffSeconds);
                    }
                })
                .catch(error => {
                    console.error('Error fetching time metrics:', error);
                    // Use current values if fetch fails
                    updateTimeDisplay();
                });
        }
        
        // ========== DURASI SEJAK STATUS TERAKHIR ==========
        // ✅ PERUBAHAN: Gunakan fungsi yang sama dengan Operator View untuk sinkronisasi
        let sinceLastChangeInterval = null;
        let lastChangeTimestamp = null;

        function updateSinceLastChange(initialTimeSeconds) {
            const sinceLastStatusEl = document.getElementById('since-last-status');
            if (!sinceLastStatusEl) return;
            
            // Clear existing interval
            if (sinceLastChangeInterval) {
                clearInterval(sinceLastChangeInterval);
            }
            
            // Calculate the timestamp when last change occurred
            // initialTimeSeconds is the duration in seconds since last change
            const now = new Date();
            lastChangeTimestamp = new Date(now.getTime() - (initialTimeSeconds * 1000));
            
            // Update immediately
            updateTimerDisplay();
            
            // Update every second
            sinceLastChangeInterval = setInterval(() => {
                updateTimerDisplay();
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const sinceLastStatusEl = document.getElementById('since-last-status');
            if (!sinceLastStatusEl || !lastChangeTimestamp) return;
            
            const now = new Date();
            const diffMs = now.getTime() - lastChangeTimestamp.getTime();
            const totalSeconds = Math.floor(diffMs / 1000);
            
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            sinceLastStatusEl.textContent = timeString;
        }
        
        // Initialize durasi sejak status terakhir
        @if (Model.ActiveJob != null)
        {
            <text>
            // ✅ PERUBAHAN: Gunakan SinceLastChangeSeconds seperti Operator View
            const initialSeconds = @(Model.ActiveJob?.SinceLastChangeSeconds ?? 0);
            if (initialSeconds >= 0) {
                updateSinceLastChange(initialSeconds);
            }
            </text>
        }

        // Update time display with real-time calculation
        function updateTimeDisplay() {
            // Ensure base values are valid numbers
            const baseOperating = Number(baseOperatingSeconds) || 0;
            const baseDowntime = Number(baseDowntimeSeconds) || 0;

            // Calculate current values dengan real-time increment
            // Operating Time bertambah jika ada active job DAN tidak ada active downtime (running)
            let currentOperatingSeconds = baseOperating;
            if (hasActiveJob && !hasActiveDowntime) {
                // Operating time bertambah setiap detik jika running
                currentOperatingSeconds = baseOperating + realTimeCounter;
            }

            // Downtime bertambah jika ada active downtime
            let currentDowntimeSeconds = baseDowntime;
            if (hasActiveDowntime) {
                // Downtime bertambah setiap detik jika ada downtime aktif
                currentDowntimeSeconds = baseDowntime + realTimeCounter;
            }

            // Planned Production Time = Operating Time + Downtime
            // Selalu hitung dari current values (sudah termasuk real-time increment jika ada aktivitas)
            let currentPlannedSeconds = currentOperatingSeconds + currentDowntimeSeconds;
            
            // PASTIKAN: Jika tidak ada aktivitas, Planned Production Time tetap dihitung dari base values
            // Ini memastikan waktu selalu ter-display, meskipun tidak bertambah
            if (currentPlannedSeconds === 0 && baseOperating === 0 && baseDowntime === 0) {
                // Jika belum ada data sama sekali, tetap tampilkan 00:00:00
                currentPlannedSeconds = 0;
            }

            // Update Planned Production Time
            const plannedEl = document.getElementById('planned-production-time');
            if (plannedEl) {
                plannedEl.textContent = formatTime(currentPlannedSeconds);
            }

            // Update Operating Time
            const operatingEl = document.getElementById('operating-time');
            if (operatingEl) {
                operatingEl.textContent = formatTime(currentOperatingSeconds);
            }

            // Update Downtime
            const downtimeEl = document.getElementById('downtime-total');
            if (downtimeEl) {
                downtimeEl.textContent = formatTime(currentDowntimeSeconds);
            }

            // Update progress bars dengan warna dinamis
            const operatingProgressBar = document.getElementById('operating-progress-bar');
            const downtimeProgressBar = document.getElementById('downtime-progress-bar');
            
            if (operatingProgressBar) {
                if (currentPlannedSeconds > 0) {
                    const operatingPercent = (currentOperatingSeconds / currentPlannedSeconds * 100);
                    operatingProgressBar.style.width = operatingPercent.toFixed(1) + '%';
                    
                    // Logika warna dinamis: Hijau >=80%, Kuning 50-80%, Merah <50%
                    const operatingColor = operatingPercent >= 80 ? '#28a745' : 
                                          operatingPercent >= 50 ? '#ffc107' : '#dc3545';
                    operatingProgressBar.style.setProperty('background-color', operatingColor, 'important');
                } else {
                    // Default warna jika tidak ada planned time
                    operatingProgressBar.style.setProperty('background-color', '#28a745', 'important');
                }
            }

            if (downtimeProgressBar) {
                if (currentPlannedSeconds > 0) {
                    const downtimePercent = (currentDowntimeSeconds / currentPlannedSeconds * 100);
                    downtimeProgressBar.style.width = downtimePercent.toFixed(1) + '%';
                    
                    // Logika warna dinamis: Merah >20%, Kuning 10-20%, Hijau <10%
                    const downtimeColor = downtimePercent > 20 ? '#dc3545' : 
                                        downtimePercent > 10 ? '#ffc107' : '#28a745';
                    downtimeProgressBar.style.setProperty('background-color', downtimeColor, 'important');
                } else {
                    // Default warna jika tidak ada planned time
                    downtimeProgressBar.style.setProperty('background-color', '#dc3545', 'important');
                }
            }
            
            // Update Good dan Reject progress bars dengan warna dinamis
            const goodProgressBar = document.getElementById('good-progress-bar');
            const rejectProgressBar = document.getElementById('reject-progress-bar');
            
            if (goodProgressBar) {
                const goodWidth = parseFloat(goodProgressBar.style.width) || 0;
                // Logika warna dinamis: Hijau >=95%, Kuning 80-95%, Merah <80%
                const goodColor = goodWidth >= 95 ? '#28a745' : 
                                goodWidth >= 80 ? '#ffc107' : '#dc3545';
                goodProgressBar.style.setProperty('background-color', goodColor, 'important');
            }
            
            if (rejectProgressBar) {
                const rejectWidth = parseFloat(rejectProgressBar.style.width) || 0;
                // Logika warna dinamis: Merah >5%, Kuning 2-5%, Hijau <2%
                const rejectColor = rejectWidth > 5 ? '#dc3545' : 
                                  rejectWidth > 2 ? '#ffc107' : '#28a745';
                rejectProgressBar.style.setProperty('background-color', rejectColor, 'important');
            }
        }

        // Initialize function - bisa dipanggil langsung atau saat DOM ready
        function initializeTimeMetrics() {
            console.log('🚀 Initializing Time Metrics real-time update...');
            console.log('📊 Initial state:', {
                hasActiveJob: hasActiveJob,
                hasActiveDowntime: hasActiveDowntime,
                baseOperating: baseOperatingSeconds,
                baseDowntime: baseDowntimeSeconds,
                basePlanned: basePlannedSeconds
            });
            
            // Initialize counter
            realTimeCounter = 0;
            
            // Initialize display dengan server-side values terlebih dahulu
            // Ini memastikan tampilan langsung muncul tanpa menunggu fetch
            updateTimeDisplay();
            console.log('📊 Initial display updated');

            // Start real-time counter immediately (update every second)
            // Counter akan bertambah setiap detik dan durasi akan update secara real-time
            // Ini memastikan waktu berjalan real-time sejak page load
            startTimeCounter();

            // Fetch initial data to get active job/downtime status
            // Setelah fetch, counter akan di-reset dan mulai dari 0
            // Tapi real-time counter tetap berjalan, jadi waktu tetap update setiap detik
            fetchTimeMetrics().then(() => {
                // Setelah fetch pertama selesai, pastikan display ter-update
                updateTimeDisplay();
                console.log('✅ Initial fetch completed, display updated');
                console.log('📊 Updated state:', {
                    hasActiveJob: hasActiveJob,
                    hasActiveDowntime: hasActiveDowntime,
                    baseOperating: baseOperatingSeconds,
                    baseDowntime: baseDowntimeSeconds,
                    basePlanned: basePlannedSeconds
                });
            }).catch(error => {
                console.error('❌ Error in initial fetch:', error);
            });

            // Refresh data every 10 seconds to get updated base values and status
            // Setiap fetch, counter akan di-reset karena base values sudah update
            // Tapi real-time counter tetap berjalan, jadi waktu tetap update setiap detik
            setInterval(() => {
                fetchTimeMetrics();
            }, 10000);
        }

        // Initialize on page load - dengan fallback jika DOM sudah ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTimeMetrics);
        } else {
            // DOM sudah ready, langsung jalankan
            initializeTimeMetrics();
        }

            // ========== SIGNALR CONNECTION FOR REAL-TIME UPDATES ==========
            let oeeConnection = null;
            try {
                oeeConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/oeeHub")
                    .build();
            } catch (error) {
                console.error('❌ Error creating SignalR connection:', error);
            }
            
            if (oeeConnection) {

                oeeConnection.on("OeeUpdated", function (data) {
                    console.log('📢 OeeUpdated received in OEE View:', data);
                    
                    // Jika MachineId sesuai atau ada flag RefreshTimeMetrics
                    if (data.MachineId === machineId || data.RefreshTimeMetrics || 
                        data.Type === "MachineStarted" || 
                        data.Type === "MachineStopped" || 
                        data.Type === "DowntimeStarted" || 
                        data.Type === "DowntimeEnded") {
                        
                        // Refresh Time Metrics immediately
                        console.log('🔄 Refreshing Time Metrics due to action update');
                        fetchTimeMetrics();
                        
                        // Refresh operator data untuk update action buttons dan timer
                        fetchOperatorDataForOee();
                        
                        // Juga refresh setelah 2 detik untuk memastikan sinkronisasi
                        setTimeout(() => {
                            fetchTimeMetrics();
                            fetchOperatorDataForOee();
                        }, 2000);
                    }
                });

                oeeConnection.start()
                    .then(() => {
                        console.log('✅ SignalR connected in OEE View');
                    })
                    .catch(err => {
                        console.error('❌ SignalR connection error in OEE View:', err);
                    });
            }

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (oeeConnection) {
                    oeeConnection.stop();
                }
                if (timeMetricsInterval) {
                    clearInterval(timeMetricsInterval);
                }
                if (sinceLastStatusInterval) {
                    clearInterval(sinceLastStatusInterval);
                }
            });
        });

        // ========== ACTION BUTTONS & TIMER SYNCHRONIZATION ==========
        let hasActiveJobOee = @(Model.HasActiveJob.ToString().ToLower());
        let hasActiveDowntimeOee = @(Model.HasActiveDowntime.ToString().ToLower());
        let machineStatusOee = '@Model.MachineStatus.ToString()';

        // Update action buttons state
        function updateActionButtonsOee(data) {
            // Defensive: Check if data exists
            if (!data) {
                data = {};
            }
            
            const btnRunning = document.getElementById('btn-running');
            const btnRest = document.getElementById('btn-rest');
            const btnLineStop = document.getElementById('btn-line-stop');
            
            // Safe property access with fallbacks
            const machineStatusFromAdmin = (data?.MachineStatus ?? machineStatusOee ?? '').toString().trim();
            const isDisabledByAdmin = machineStatusFromAdmin === 'TidakAktif';
            const hasActiveJobValue = data?.HasActiveJob ?? hasActiveJobOee ?? false;
            const hasActiveDowntimeValue = data?.HasActiveDowntime ?? hasActiveDowntimeOee ?? false;
            
            // Update RUNNING button
            if (btnRunning) {
                const shouldDisable = isDisabledByAdmin || (hasActiveJobValue && !hasActiveDowntimeValue);
                btnRunning.disabled = shouldDisable;
                if (shouldDisable) {
                    btnRunning.style.opacity = '0.6';
                    btnRunning.style.cursor = 'not-allowed';
                } else {
                    btnRunning.style.opacity = '1';
                    btnRunning.style.cursor = 'pointer';
                }
            }
            
            // Update REST button
            if (btnRest) {
                const shouldDisable = isDisabledByAdmin || (hasActiveJobValue && !hasActiveDowntimeValue);
                btnRest.disabled = shouldDisable;
                if (shouldDisable) {
                    btnRest.style.opacity = '0.6';
                    btnRest.style.cursor = 'not-allowed';
                } else {
                    btnRest.style.opacity = '1';
                    btnRest.style.cursor = 'pointer';
                }
            }
            
            // Update LINE STOP button
            if (btnLineStop) {
                const shouldDisable = isDisabledByAdmin || (hasActiveJobValue && !hasActiveDowntimeValue);
                btnLineStop.disabled = shouldDisable;
                if (shouldDisable) {
                    btnLineStop.style.opacity = '0.6';
                    btnLineStop.style.cursor = 'not-allowed';
                } else {
                    btnLineStop.style.opacity = '1';
                    btnLineStop.style.cursor = 'pointer';
                }
            }
        }

        // Update machine status display
        function updateMachineStatusOee(data) {
            // Defensive: Check if data exists
            if (!data) {
                data = {};
            }
            
            const statusBadgeEl = document.getElementById('machine-status-badge');
            const downtimeDescEl = document.getElementById('downtime-description');
            const machineStatusInfoEl = document.getElementById('machine-status-info');
            
            // Safe property access with fallbacks
            const machineStatusFromAdmin = (data?.MachineStatus ?? machineStatusOee ?? '').toString().trim();
            const isAktif = machineStatusFromAdmin === 'Aktif';
            
            // Update badge in header
            if (statusBadgeEl) {
                statusBadgeEl.textContent = isAktif ? 'AKTIF' : 'TIDAK AKTIF';
                statusBadgeEl.className = `badge ${isAktif ? 'bg-success' : 'bg-warning'}`;
            }
            
            // Update machine status info
            if (machineStatusInfoEl) {
                if (isAktif) {
                    machineStatusInfoEl.style.display = 'none';
                } else {
                    machineStatusInfoEl.style.display = 'inline';
                }
            }
            
            // Update downtime description
            if (downtimeDescEl) {
                if (data?.HasActiveDowntime && data?.ActiveDowntimeDescription) {
                    downtimeDescEl.textContent = data.ActiveDowntimeDescription;
                    downtimeDescEl.style.display = 'inline';
                } else {
                    downtimeDescEl.style.display = 'none';
                }
            }
        }

        // Update progress bar and production data
        function updateProductionDataOee(data) {
            // Defensive: Check if data exists
            if (!data || typeof data !== 'object') {
                console.warn('updateProductionDataOee: Invalid data', data);
                return;
            }
            
            const progressBar = document.getElementById('progress-bar');
            const progressPercent = document.getElementById('progress-percent');
            const progressText = document.getElementById('progress-text');
            const totalGoodEl = document.getElementById('total-good');
            const totalRejectEl = document.getElementById('total-reject');
            const estimatedCompletion = document.getElementById('estimated-completion');
            
            // Update progress bar safely
            if (progressBar && progressPercent && progressText) {
                try {
                    const percent = Math.max(0, Math.min(100, data.ProgressPercent ?? 0));
                    progressBar.style.width = percent + '%';
                    progressBar.setAttribute('aria-valuenow', percent);
                    progressPercent.textContent = percent.toFixed(1) + '%';
                    
                    const totalGood = data.TotalGood ?? 0;
                    const targetQty = data.TargetQuantity ?? 0;
                    progressText.textContent = `${totalGood} / ${targetQty}`;
                    
                    // Change color based on progress
                    progressBar.classList.remove('bg-success', 'bg-warning', 'bg-primary', 'bg-info');
                    if (percent >= 100) {
                        progressBar.classList.add('bg-info');
                    } else if (percent >= 80) {
                        progressBar.classList.add('bg-warning');
                    } else {
                        progressBar.classList.add('bg-primary');
                    }
                } catch (error) {
                    console.error('Error updating progress bar:', error);
                }
            }
            
            // Update total good safely
            if (totalGoodEl) {
                try {
                    const oldValue = parseInt(totalGoodEl.textContent) || 0;
                    const newValue = data.TotalGood ?? 0;
                    totalGoodEl.textContent = newValue;
                    
                    // Animate change
                    if (newValue > oldValue) {
                        totalGoodEl.classList.add('text-success');
                        setTimeout(() => totalGoodEl.classList.remove('text-success'), 1000);
                    }
                } catch (error) {
                    console.error('Error updating total good:', error);
                }
            }
            
            // Update total reject safely
            if (totalRejectEl) {
                try {
                    const oldValue = parseInt(totalRejectEl.textContent) || 0;
                    const newValue = data.TotalReject ?? 0;
                    totalRejectEl.textContent = newValue;
                    
                    // Animate change
                    if (newValue > oldValue) {
                        totalRejectEl.classList.add('text-danger');
                        setTimeout(() => totalRejectEl.classList.remove('text-danger'), 1000);
                    }
                } catch (error) {
                    console.error('Error updating total reject:', error);
                }
            }
            
            // Update estimated completion safely
            if (estimatedCompletion) {
                try {
                    estimatedCompletion.textContent = data.EstimatedCompletion ?? '-';
                } catch (error) {
                    console.error('Error updating estimated completion:', error);
                }
            }
        }

        // Reset timer when action button is clicked
        function resetTimerOnAction() {
            // Reset timer to 0 when action is triggered
            if (lastChangeTimestamp) {
                lastChangeTimestamp = new Date();
                updateTimerDisplay();
            }
        }

        // Add event listeners to action buttons to reset timer
        document.addEventListener('DOMContentLoaded', function() {
            const runningForm = document.getElementById('running-form');
            const restForm = document.getElementById('rest-form');
            const lineStopBtn = document.getElementById('btn-line-stop');
            
            if (runningForm) {
                runningForm.addEventListener('submit', function() {
                    resetTimerOnAction();
                });
            }
            
            if (restForm) {
                restForm.addEventListener('submit', function() {
                    resetTimerOnAction();
                });
            }
            
            if (lineStopBtn) {
                lineStopBtn.addEventListener('click', function() {
                    // Timer akan di-reset setelah line stop dimulai (via SignalR update)
                });
            }
            
            // Initialize action buttons state
            updateActionButtonsOee({
                MachineStatus: machineStatusOee,
                HasActiveJob: hasActiveJobOee,
                HasActiveDowntime: hasActiveDowntimeOee
            });
        });

        // Fetch operator data untuk update action buttons dan production data
        async function fetchOperatorDataForOee() {
            const machineId = '@Model.MachineId';
            if (!machineId) {
                console.warn('Machine ID is not available');
                return;
            }
            
            try {
                const response = await fetch(`/Operator/GetOperatorData?machineId=${machineId}`);
                if (!response.ok) {
                    console.warn(`HTTP error! status: ${response.status}`);
                    return;
                }
                
                const data = await response.json();
                
                // Defensive: Check if data exists and has expected structure
                if (!data || typeof data !== 'object') {
                    console.warn('Unexpected data structure:', data);
                    return;
                }
                
                // Update state with safe defaults
                hasActiveJobOee = data?.HasActiveJob ?? false;
                hasActiveDowntimeOee = data?.HasActiveDowntime ?? false;
                machineStatusOee = data?.MachineStatus ?? machineStatusOee;
                
                // Update timer jika ada LastStatusChangeTime atau SinceLastChangeSeconds
                if (data?.SinceLastChangeSeconds !== undefined && data.SinceLastChangeSeconds !== null) {
                    updateSinceLastChange(data.SinceLastChangeSeconds);
                } else if (data?.LastStatusChangeTime) {
                    try {
                        const lastChangeTime = new Date(data.LastStatusChangeTime);
                        if (!isNaN(lastChangeTime.getTime())) {
                            const now = new Date();
                            const diffSeconds = Math.floor((now.getTime() - lastChangeTime.getTime()) / 1000);
                            updateSinceLastChange(Math.max(0, diffSeconds));
                        }
                    } catch (dateError) {
                        console.warn('Error parsing LastStatusChangeTime:', dateError);
                    }
                }
                
                // Update action buttons
                updateActionButtonsOee(data);
                
                // Update machine status
                updateMachineStatusOee(data);
                
                // Update production data
                updateProductionDataOee(data);
            } catch (error) {
                console.error('Error fetching operator data for OEE:', error);
                // Don't break the UI, just log the error
            }
        }

        // Fetch operator data every 5 seconds untuk sinkronisasi
        setInterval(() => {
            fetchOperatorDataForOee();
        }, 5000);

        // Initial fetch
        fetchOperatorDataForOee();
    </script>
    
    <style>
        /* Action Buttons Horizontal Layout */
        #running-form,
        #rest-form {
            margin: 0;
        }
        
        /* Ensure buttons are clickable */
        button[type="submit"]:not(:disabled),
        #btn-running:not(:disabled),
        #btn-rest:not(:disabled),
        #btn-line-stop:not(:disabled) {
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        /* Button hover effects */
        .btn-outline-success:hover:not(:disabled),
        .btn-outline-warning:hover:not(:disabled),
        .btn-outline-danger:hover:not(:disabled),
        .btn-primary:hover:not(:disabled) {
            transform: scale(1.02);
            transition: transform 0.2s ease;
        }
        
        /* Responsive: Stack buttons on small screens */
        @@media (max-width: 768px) {
            .col-md-3 {
                margin-bottom: 0.5rem;
            }
        }
    </style>
}

