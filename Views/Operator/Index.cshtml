@model OperatorViewModel
@{
    ViewData["Title"] = "Operator Panel - " + Model.MachineName;
    var total = Model.TotalGood + Model.TotalReject;
    var progressPercent = Model.TargetQuantity > 0
        ? Math.Min(100, (double)Model.TotalGood / Model.TargetQuantity * 100)
        : 0;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="fa-solid fa-microchip me-2"></i>@Model.MachineName
        </h2>
        <div class="text-secondary small">
            <i class="fa-solid fa-user me-1"></i>Operator: @(Model.OperatorName ?? "-")
            @if (Model.HasActiveDowntime && !string.IsNullOrEmpty(Model.ActiveDowntimeDescription))
            {
                <span class="ms-3">
                    <i class="fa-solid fa-triangle-exclamation me-1"></i>LINE STOP: @Model.ActiveDowntimeDescription
                </span>
            }
        </div>
    </div>
    <div>
        @{
            var statusClass = Model.MachineStatus switch
            {
                MachineStatus.Aktif => "status-running",
                MachineStatus.TidakAktif => "status-down",
                _ => "status-idle"
            };
            var statusText = Model.MachineStatus == MachineStatus.Aktif ? "Aktif" : "Tidak Aktif";
        }
        <span class="status-badge @statusClass" id="header-status-badge">@statusText</span>
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary btn-sm ms-2">
            <i class="fa-solid fa-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>
</div>

<div class="row g-3">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Current Job</h5>
                @if (!string.IsNullOrEmpty(Model.ProductImageUrl))
                {
                    <img src="@Model.ProductImageUrl" alt="@Model.ProductName" class="img-fluid rounded mb-2" />
                    <div class="fw-semibold">@Model.ProductName</div>
                    <div class="small text-secondary mb-2">WO: @Model.WorkOrderNumber</div>
                }
                else
                {
                    <div class="text-secondary">Tidak ada job aktif.</div>
                }

                <div class="mt-3">
                    <div class="d-flex justify-content-between small">
                        <span>Progress</span>
                        <span id="progress-text">@Model.TotalGood / @Model.TargetQuantity</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div id="progress-bar" class="progress-bar bg-success" role="progressbar" style="width: @progressPercent.ToString("0")%;" aria-valuenow="@progressPercent" aria-valuemin="0" aria-valuemax="100">
                            <span id="progress-percent">@progressPercent.ToString("0")%</span>
                        </div>
                    </div>
                    <div class="small mt-1 text-secondary">
                        Total Good: <span id="total-good" class="fw-bold text-success">@Model.TotalGood</span> ‚Ä¢ 
                        Reject: <span id="total-reject" class="fw-bold text-danger">@Model.TotalReject</span>
                    </div>
                    @if (Model.TargetQuantity > 0)
                    {
                        <div class="small mt-1 text-info">
                            <i class="fa-solid fa-clock me-1"></i>
                            Est. Completion: <span id="estimated-completion">-</span>
                        </div>
                    }
                </div>

                <div class="mt-3">
                    <div class="text-secondary small">Durasi sejak status terakhir</div>
                    <div class="fs-5 fw-bold" id="since-last-change">
                        @Model.SinceLastChange.ToString(@"hh\:mm\:ss")
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">Actions</h5>
                <div class="d-grid gap-2 mb-3">
                    <!-- RUNNING PROCESS Button - Submit form natural dengan type="submit" -->
                    <form asp-action="Start" method="post" id="running-form" style="margin: 0;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="machineId" value="@Model.MachineId" />
                        <button type="submit" 
                                id="btn-running" 
                                class="btn btn-lg w-100 btn-outline-success"
                                style="pointer-events: auto !important; cursor: pointer !important;"
                                @(Model.MachineStatus == MachineStatus.TidakAktif || (Model.HasActiveJob && !Model.HasActiveDowntime) ? "disabled" : "")>
                            <i class="fa-solid fa-play-circle me-2"></i>
                            RUNNING PROCESS
                        </button>
                    </form>

                    <!-- ISTIRAHAT Button - Submit form natural dengan type="submit" -->
                    @if (Model.RestReason != null)
                    {
                        <form asp-action="Rest" method="post" id="rest-form" style="margin: 0;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="machineId" value="@Model.MachineId" />
                            <input type="hidden" name="reasonId" value="@Model.RestReason.Id" />
                            <button type="submit" 
                                    id="btn-rest" 
                                    class="btn btn-lg w-100 btn-outline-warning"
                                    style="pointer-events: auto !important; cursor: pointer !important;"
                                    @(Model.MachineStatus == MachineStatus.TidakAktif || (Model.HasActiveJob && !Model.HasActiveDowntime) ? "disabled" : "")>
                                <i class="fa-solid fa-pause-circle me-2"></i>
                                ISTIRAHAT (@Model.RestReason.Description)
                            </button>
                        </form>
                    }

                    <!-- LINE STOP Button - Buka modal natural dengan data-bs-toggle -->
                    <button type="button" 
                            id="btn-line-stop" 
                            class="btn btn-lg w-100 btn-outline-danger"
                            style="pointer-events: auto !important; cursor: pointer !important;"
                            data-bs-toggle="modal" 
                            data-bs-target="#lineStopModal"
                            @(Model.MachineStatus == MachineStatus.TidakAktif || (Model.HasActiveJob && !Model.HasActiveDowntime) ? "disabled" : "")>
                        <i class="fa-solid fa-stop-circle me-2"></i>
                        LINE STOP
                    </button>

                    <!-- TAMBAH QTY Button (always enabled) -->
                    <button type="button" class="btn btn-lg btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addQtyModal">
                        <i class="fa-solid fa-plus-circle me-2"></i>
                        TAMBAH QTY
                    </button>
                </div>
                <div class="mt-auto">
                    <div class="text-secondary small">Status:</div>
                    <div class="fs-4 fw-bold @(Model.MachineStatus == MachineStatus.Aktif ? "text-success" : "text-warning")" id="machine-status">
                        @(Model.MachineStatus == MachineStatus.Aktif ? "AKTIF" : "TIDAK AKTIF")
                    </div>
                    @if (Model.MachineStatus == MachineStatus.TidakAktif)
                    {
                        <div class="small text-warning mt-1" id="machine-status-info">
                            <i class="fa-solid fa-exclamation-triangle me-1"></i>Machine di-set Tidak Aktif di Admin
                        </div>
                    }
                    else if (Model.HasActiveDowntime && !string.IsNullOrEmpty(Model.ActiveDowntimeDescription))
                    {
                        <div class="small text-danger mt-1" id="downtime-description">
                            @Model.ActiveDowntimeDescription
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Line Stop - Hanya untuk START (pilih reason) -->
<div class="modal fade" id="lineStopModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header">
                <h5 class="modal-title">LINE STOP - Pilih Alasan</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="LineStop" method="post" id="line-stop-start-form">
                @Html.AntiForgeryToken()
                <input type="hidden" name="machineId" value="@Model.MachineId" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pilih Alasan Line Stop:</label>
                        <select class="form-select" name="reasonId" required>
                            <option value="">-- Pilih Alasan --</option>
                            @foreach (var r in Model.LineStopReasons)
                            {
                                <option value="@r.Id">@r.Description (@r.Category)</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fa-solid fa-play me-2"></i>START LINE STOP
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Tambah Qty -->
<div class="modal fade" id="addQtyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header">
                <h5 class="modal-title">Tambah Output</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="AddQuantity" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="machineId" value="@Model.MachineId" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Good Qty</label>
                        <input type="number" class="form-control" name="goodQty" value="0" min="0" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reject Qty</label>
                        <input type="number" class="form-control" name="rejectQty" value="0" min="0" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jenis NG (jika ada reject)</label>
                        <select class="form-select" name="ngTypeId">
                            <option value="">-- Pilih Jenis NG --</option>
                            @foreach (var ng in Model.NgTypes)
                            {
                                <option value="@ng.Id">@ng.Code - @ng.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Alasan Reject (optional)</label>
                        <input type="text" class="form-control" name="rejectReason" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        /* CSS sederhana untuk action buttons - tidak memblokir form submission */
        /* Hapus semua CSS untuk .action-switch karena sudah tidak digunakan */
        
        /* Pastikan form bisa di-submit secara natural */
        #running-form,
        #rest-form {
            position: relative;
            pointer-events: auto !important;
        }
        
        /* Pastikan button submit bisa diklik - OVERRIDE semua yang mungkin memblokir */
        button[type="submit"]:not(:disabled),
        #btn-running:not(:disabled),
        #btn-rest:not(:disabled) {
            pointer-events: auto !important;
            cursor: pointer !important;
            opacity: 1 !important;
        }
        
        /* Pastikan button LINE STOP bisa diklik */
        #btn-line-stop:not(:disabled) {
            pointer-events: auto !important;
            cursor: pointer !important;
            opacity: 1 !important;
        }
        
        /* Visual feedback sederhana untuk button hover */
        .btn-outline-success:hover:not(:disabled),
        .btn-outline-warning:hover:not(:disabled),
        .btn-outline-danger:hover:not(:disabled) {
            transform: scale(1.02);
            transition: transform 0.2s ease;
        }
        
        .btn-outline-success:active:not(:disabled),
        .btn-outline-warning:active:not(:disabled),
        .btn-outline-danger:active:not(:disabled) {
            transform: scale(0.98);
        }
    </style>
    <script>
        // ========== REAL-TIME PRODUCTION MONITORING ==========
        let connection;
        let refreshInterval;
        // ‚úÖ PERBAIKAN: Pastikan machineId adalah string dengan quote
        const machineId = '@Model.MachineId';
        const targetQuantity = @Model.TargetQuantity;

        // ‚úÖ PERBAIKAN: Flag untuk skip timer update jika baru di-reset
        let skipTimerUpdate = false;
        let timerResetTime = null; // Timestamp saat timer di-reset
        
        // ‚úÖ PERBAIKAN: Flag untuk mencegah duplicate form handlers
        let formHandlersSetup = false;

        // Initialize SignalR connection untuk real-time update
        function initializeSignalR() {
            if (typeof signalR === 'undefined') {
                console.error('‚ùå SignalR library not loaded!');
                startPeriodicRefresh();
                return;
            }

            console.log('üöÄ Initializing SignalR connection for Operator Panel...');
            console.log('üîç MachineId:', machineId); // ‚úÖ Debug: log machineId untuk verifikasi

            connection = new signalR.HubConnectionBuilder()
                .withUrl("/oeeHub")
                .withAutomaticReconnect({
                    nextRetryDelayInMilliseconds: retryContext => {
                        if (retryContext.elapsedMilliseconds < 2000) return 0;
                        if (retryContext.elapsedMilliseconds < 5000) return 2000;
                        if (retryContext.elapsedMilliseconds < 10000) return 5000;
                        return 10000;
                    }
                })
                .build();

            // Event handler untuk OEE update
            connection.on("OeeUpdated", function (data) {
                console.log('üîî OEE Update Received:', data);
                
                // ‚úÖ PERBAIKAN: Jika update untuk mesin ini, refresh data
                if (String(data.MachineId) === String(machineId)) {
                    // Jika MachineStatusUpdated, langsung refresh untuk sinkronisasi dengan Admin
                    if (data.Type === "MachineStatusUpdated") {
                        console.log('üîÑ Machine status updated from Admin - refreshing data immediately');
                        console.log('üìä New status from Admin:', data.MachineStatus);
                        
                        // ‚úÖ PERBAIKAN: Update UI langsung dengan data dari SignalR untuk respons cepat
                        if (data.MachineStatus) {
                            const updateData = {
                                MachineStatus: data.MachineStatus,
                                HasActiveJob: hasActiveJob, // Keep current state
                                HasActiveDowntime: hasActiveDowntime // Keep current state
                            };
                            updateStatus(updateData);
                        }
                        
                        // ‚úÖ PERBAIKAN: Reset timer saat status berubah dari Admin
                        // Karena status berubah, berarti ada perubahan state, reset timer
                        skipTimerUpdate = true;
                        timerResetTime = new Date();
                        updateSinceLastChange(0);
                        console.log('‚è±Ô∏è Timer reset to 00:00:00 (status changed from Admin)');
                        
                        // Refresh data untuk mendapatkan status terbaru dari database
                        refreshOperatorData();
                    }
                    // Jika MachineStarted, reset timer immediately
                    else if (data.Type === "MachineStarted") {
                        console.log('üîÑ Machine started - resetting timer');
                        skipTimerUpdate = true;
                        timerResetTime = new Date();
                        updateSinceLastChange(0); // Reset ke 00:00:00
                        console.log('‚è±Ô∏è Timer reset to 00:00:00 (MachineStarted)');
                        refreshOperatorData();
                    }
                    // Jika DowntimeStarted atau DowntimeEnded, reset timer
                    else if (data.Type === "DowntimeStarted" || data.Type === "DowntimeEnded") {
                        console.log('üîÑ Downtime status changed - resetting timer');
                        skipTimerUpdate = true;
                        timerResetTime = new Date();
                        updateSinceLastChange(0); // Reset timer karena ada perubahan status
                        console.log('‚è±Ô∏è Timer reset to 00:00:00 (Downtime status changed)');
                        refreshOperatorData();
                    }
                    // Untuk update lainnya, refresh juga
                    else {
                        refreshOperatorData();
                    }
                }
            });

            // ‚úÖ PERBAIKAN: Event handler untuk connection state changes
            connection.onreconnecting((error) => {
                console.warn('üîÑ SignalR reconnecting...', error ? error.message : '');
                // Jangan start periodic refresh saat reconnecting, biarkan SignalR handle
            });

            connection.onreconnected((connectionId) => {
                console.log('‚úÖ SignalR reconnected! Connection ID:', connectionId);
                // Stop periodic refresh karena SignalR sudah connected
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                refreshOperatorData();
            });

            connection.onclose((error) => {
                console.warn('‚ö†Ô∏è SignalR connection closed:', error);
                if (error) {
                    console.error('   Error details:', error.message);
                }
                // Start periodic refresh sebagai fallback
                startPeriodicRefresh();
            });

            // Start connection dengan error handling yang lebih baik
            connection.start()
                .then(() => {
                    console.log('‚úÖ SignalR connected for Operator Panel!');
                    // Stop periodic refresh karena SignalR sudah connected
                    if (refreshInterval) {
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                })
                .catch((err) => {
                    console.error('‚ùå SignalR connection error:', err);
                    console.error('   Error details:', err.message);
                    // Start periodic refresh sebagai fallback
                    startPeriodicRefresh();
                });
        }

        // ‚úÖ PERBAIKAN: Refresh operator data dengan error handling yang lebih baik
        function refreshOperatorData() {
            const url = `/Operator/GetOperatorData?machineId=${encodeURIComponent(machineId)}`;
            console.log('üì° Fetching operator data from:', url); // ‚úÖ Debug logging
            
            fetch(url)
                .then(response => {
                    // ‚úÖ PERBAIKAN: Check response status sebelum parse JSON
                    if (!response.ok) {
                        // Jika 404 atau error lain, throw error dengan detail
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Operator data updated:', data);
                    
                    // ‚úÖ PERBAIKAN: Handle camelCase dari JSON (ASP.NET Core default)
                    // JSON menggunakan camelCase: machineStatus, hasActiveJob, dll
                    // Tapi kita juga support PascalCase untuk backward compatibility
                    const machineStatus = data.machineStatus || data.MachineStatus;
                    const hasActiveJob = data.hasActiveJob !== undefined ? data.hasActiveJob : (data.HasActiveJob || false);
                    const hasActiveDowntime = data.hasActiveDowntime !== undefined ? data.hasActiveDowntime : (data.HasActiveDowntime || false);
                    const lastStatusChangeTime = data.lastStatusChangeTime || data.LastStatusChangeTime;
                    
                    console.log('üîç MachineStatus from API (normalized):', machineStatus, 'Type:', typeof machineStatus);
                    console.log('üîç Normalized data:', {
                        machineStatus: machineStatus,
                        hasActiveJob: hasActiveJob,
                        hasActiveDowntime: hasActiveDowntime,
                        lastStatusChangeTime: lastStatusChangeTime
                    });
                    
                    // ‚úÖ PERBAIKAN: Pastikan MachineStatus ada sebelum update
                    if (!machineStatus) {
                        console.error('‚ùå ERROR: MachineStatus is missing from API response!', data);
                        console.error('   Full response:', JSON.stringify(data, null, 2));
                        return;
                    }
                    
                    // ‚úÖ PERBAIKAN: Normalize data untuk digunakan di updateStatus
                    const normalizedData = {
                        MachineStatus: machineStatus,
                        HasActiveJob: hasActiveJob,
                        HasActiveDowntime: hasActiveDowntime,
                        ActiveDowntimeDescription: data.activeDowntimeDescription || data.ActiveDowntimeDescription,
                        TotalGood: data.totalGood || data.TotalGood || 0,
                        TotalReject: data.totalReject || data.TotalReject || 0,
                        TargetQuantity: data.targetQuantity || data.TargetQuantity || 0,
                        ProgressPercent: data.progressPercent || data.ProgressPercent || 0,
                        SinceLastChangeSeconds: data.sinceLastChangeSeconds || data.SinceLastChangeSeconds,
                        SinceLastChange: data.sinceLastChange || data.SinceLastChange,
                        LastStatusChangeTime: lastStatusChangeTime,
                        ProductName: data.productName || data.ProductName,
                        WorkOrderNumber: data.workOrderNumber || data.WorkOrderNumber,
                        ProductImageUrl: data.productImageUrl || data.ProductImageUrl
                    };
                    
                    // Update counters
                    updateCounters(normalizedData);
                    
                    // Update progress bar
                    updateProgressBar(normalizedData);
                    
                    // ‚úÖ PERBAIKAN: Update status dengan normalized data
                    updateStatus(normalizedData);
                    
                    // ‚úÖ PERBAIKAN: Pastikan button state di-update lagi setelah refresh
                    // Ini memastikan button state sinkron dengan data terbaru setelah form submit
                    setTimeout(() => {
                        updateActionButtons(normalizedData);
                        console.log('üîÑ Button states re-updated after data refresh');
                    }, 200);
                    
                    // ‚úÖ PERBAIKAN: Setup form handlers setelah button state di-update
                    // Ini memastikan handlers terpasang dengan benar setelah button di-enable
                    // Note: setupFormHandlers dipanggil setelah updateActionButtons di dalam updateStatus
                    
                    // ‚úÖ PERBAIKAN: Update timer dengan LastStatusChangeTime untuk sinkronisasi
                    // TAPI skip jika baru saja di-reset (dalam 3 detik terakhir)
                    if (skipTimerUpdate && timerResetTime) {
                        const timeSinceReset = (new Date() - timerResetTime) / 1000; // seconds
                        console.log('‚è±Ô∏è Checking timer reset flag:', {
                            skipTimerUpdate: skipTimerUpdate,
                            timerResetTime: timerResetTime,
                            timeSinceReset: timeSinceReset.toFixed(1) + 's'
                        });
                        
                        if (timeSinceReset < 3) {
                            console.log('‚è±Ô∏è Skipping timer update (recently reset, ' + timeSinceReset.toFixed(1) + 's ago)');
                            // Reset flag setelah 3 detik
                            const remainingTime = 3000 - (timeSinceReset * 1000);
                            setTimeout(() => {
                                skipTimerUpdate = false;
                                timerResetTime = null;
                                console.log('‚è±Ô∏è Timer update flag reset - will update from server next time');
                            }, remainingTime);
                            return; // ‚úÖ PERBAIKAN: Return early untuk skip timer update
                        } else {
                            // Sudah lebih dari 3 detik, reset flag dan update dari server
                            console.log('‚è±Ô∏è Timer reset flag expired, updating from server');
                            skipTimerUpdate = false;
                            timerResetTime = null;
                            
                            // Update timer dengan data dari server
                            if (normalizedData.LastStatusChangeTime) {
                                const lastChangeTime = new Date(normalizedData.LastStatusChangeTime);
                                const now = new Date();
                                const diffSeconds = Math.floor((now.getTime() - lastChangeTime.getTime()) / 1000);
                                console.log('‚è±Ô∏è Updating timer from LastStatusChangeTime:', {
                                    lastChangeTime: normalizedData.LastStatusChangeTime,
                                    parsed: lastChangeTime,
                                    diffSeconds: diffSeconds
                                });
                                updateSinceLastChange(diffSeconds);
                            } else if (normalizedData.SinceLastChangeSeconds !== undefined) {
                                updateSinceLastChange(normalizedData.SinceLastChangeSeconds);
                            } else if (normalizedData.SinceLastChange) {
                                const parts = normalizedData.SinceLastChange.split(':');
                                if (parts.length === 3) {
                                    const seconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
                                    updateSinceLastChange(seconds);
                                }
                            }
                        }
                    } else {
                        // Tidak ada flag, update normal dari server
                        if (normalizedData.LastStatusChangeTime) {
                            const lastChangeTime = new Date(normalizedData.LastStatusChangeTime);
                            const now = new Date();
                            const diffSeconds = Math.floor((now.getTime() - lastChangeTime.getTime()) / 1000);
                            console.log('‚è±Ô∏è Updating timer from LastStatusChangeTime:', {
                                lastChangeTime: normalizedData.LastStatusChangeTime,
                                parsed: lastChangeTime,
                                diffSeconds: diffSeconds
                            });
                            updateSinceLastChange(diffSeconds);
                        } else if (normalizedData.SinceLastChangeSeconds !== undefined) {
                            updateSinceLastChange(normalizedData.SinceLastChangeSeconds);
                        } else if (normalizedData.SinceLastChange) {
                            const parts = normalizedData.SinceLastChange.split(':');
                            if (parts.length === 3) {
                                const seconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
                                updateSinceLastChange(seconds);
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error fetching operator data:', error);
                    console.error('   URL:', url);
                    console.error('   MachineId:', machineId);
                    // ‚úÖ PERBAIKAN: Jangan crash aplikasi, hanya log error
                    // Aplikasi tetap berjalan meskipun ada error
                });
        }

        // State variables untuk tracking active job dan downtime
        let hasActiveJob = false;
        let hasActiveDowntime = false;

        // Update counters
        function updateCounters(data) {
            const totalGoodEl = document.getElementById('total-good');
            const totalRejectEl = document.getElementById('total-reject');
            
            if (totalGoodEl) {
                const oldValue = parseInt(totalGoodEl.textContent) || 0;
                const newValue = data.TotalGood || 0;
                totalGoodEl.textContent = newValue;
                
                // Animate change
                if (newValue > oldValue) {
                    totalGoodEl.classList.add('text-success');
                    setTimeout(() => totalGoodEl.classList.remove('text-success'), 1000);
                }
            }
            
            if (totalRejectEl) {
                const oldValue = parseInt(totalRejectEl.textContent) || 0;
                const newValue = data.TotalReject || 0;
                totalRejectEl.textContent = newValue;
                
                // Animate change
                if (newValue > oldValue) {
                    totalRejectEl.classList.add('text-danger');
                    setTimeout(() => totalRejectEl.classList.remove('text-danger'), 1000);
                }
            }
        }

        // Update progress bar
        function updateProgressBar(data) {
            const progressBar = document.getElementById('progress-bar');
            const progressPercent = document.getElementById('progress-percent');
            const progressText = document.getElementById('progress-text');
            const estimatedCompletion = document.getElementById('estimated-completion');
            
            if (progressBar && progressPercent && progressText) {
                const percent = data.ProgressPercent || 0;
                progressBar.style.width = percent + '%';
                progressBar.setAttribute('aria-valuenow', percent);
                progressPercent.textContent = percent.toFixed(1) + '%';
                progressText.textContent = `${data.TotalGood || 0} / ${data.TargetQuantity || 0}`;
                
                // Change color based on progress
                if (percent >= 100) {
                    progressBar.classList.remove('bg-success', 'bg-warning');
                    progressBar.classList.add('bg-info');
                } else if (percent >= 80) {
                    progressBar.classList.remove('bg-success', 'bg-info');
                    progressBar.classList.add('bg-warning');
                } else {
                    progressBar.classList.remove('bg-warning', 'bg-info');
                    progressBar.classList.add('bg-success');
                }
            }
            
            if (estimatedCompletion) {
                estimatedCompletion.textContent = data.EstimatedCompletion || '-';
            }
        }

        // Update status
        function updateStatus(data) {
            const statusEl = document.getElementById('machine-status');
            const downtimeDescEl = document.getElementById('downtime-description');
            const machineStatusInfoEl = document.getElementById('machine-status-info');
            
            // ‚úÖ PERBAIKAN: Update global state variables untuk sinkronisasi
            hasActiveJob = data.HasActiveJob || false;
            hasActiveDowntime = data.HasActiveDowntime || false;
            
            // ‚úÖ PERBAIKAN: SELALU gunakan MachineStatus dari Admin (prioritas utama)
            // MachineStatus dari Admin adalah sumber kebenaran
            // Normalize string untuk menghindari masalah case sensitivity atau whitespace
            const machineStatusFromAdmin = (data.MachineStatus || '').toString().trim();
            
            // ‚úÖ PERBAIKAN: Validasi MachineStatus
            if (!machineStatusFromAdmin) {
                console.error('‚ùå ERROR: MachineStatus is empty!', data);
                return; // Jangan update jika MachineStatus tidak ada
            }
            
            const isAktif = machineStatusFromAdmin === 'Aktif';
            const displayStatus = isAktif ? 'AKTIF' : 'TIDAK AKTIF';
            const headerStatusText = isAktif ? 'Aktif' : 'Tidak Aktif';
            
            console.log('üîÑ Updating machine status:', { 
                machineStatusFromAdmin, 
                machineStatusRaw: data.MachineStatus,
                isAktif,
                displayStatus,
                headerStatusText,
                hasActiveJob: hasActiveJob,
                hasActiveDowntime: hasActiveDowntime
            }); // Debug logging
            
            // ‚úÖ PERBAIKAN: Update status di card Actions (machine-status)
            if (statusEl) {
                // Update text content
                statusEl.textContent = displayStatus;
                
                // ‚úÖ PERBAIKAN: Update color berdasarkan MachineStatus dari Admin
                // Hapus semua class warna yang mungkin ada (termasuk yang di-set di server-side)
                statusEl.classList.remove('text-success', 'text-danger', 'text-warning', 'text-secondary');
                
                // ‚úÖ PERBAIKAN: Tambahkan class yang sesuai dengan force (gunakan setAttribute untuk memastikan)
                const baseClasses = 'fs-4 fw-bold';
                if (isAktif) {
                    // Hapus semua class warna terlebih dahulu
                    statusEl.classList.remove('text-success', 'text-danger', 'text-warning', 'text-secondary');
                    statusEl.classList.add('text-success');
                    // Force update dengan setAttribute untuk memastikan class ter-apply
                    statusEl.setAttribute('class', `${baseClasses} text-success`);
                    console.log('‚úÖ Status set to AKTIF (green)');
                } else {
                    // Hapus semua class warna terlebih dahulu
                    statusEl.classList.remove('text-success', 'text-danger', 'text-warning', 'text-secondary');
                    statusEl.classList.add('text-warning'); // TIDAK AKTIF = warning (kuning)
                    // Force update dengan setAttribute untuk memastikan class ter-apply
                    statusEl.setAttribute('class', `${baseClasses} text-warning`);
                    console.log('‚ö†Ô∏è Status set to TIDAK AKTIF (yellow)');
                }
            }
            
            // ‚úÖ PERBAIKAN: Update status badge di header (header-status-badge)
            const headerStatusBadge = document.getElementById('header-status-badge');
            if (headerStatusBadge) {
                // Update text content
                headerStatusBadge.textContent = headerStatusText;
                
                // Update class untuk status badge
                headerStatusBadge.classList.remove('status-running', 'status-down', 'status-idle');
                if (isAktif) {
                    headerStatusBadge.classList.add('status-running');
                    console.log('‚úÖ Header status badge set to Aktif (green)');
                } else {
                    headerStatusBadge.classList.add('status-down');
                    console.log('‚ö†Ô∏è Header status badge set to Tidak Aktif (red)');
                }
            }
            
            // Update machine status info (jika Machine Tidak Aktif)
            if (machineStatusInfoEl) {
                if (!isAktif) {
                    machineStatusInfoEl.style.display = 'block';
                    machineStatusInfoEl.innerHTML = '<i class="fa-solid fa-exclamation-triangle me-1"></i>Machine di-set Tidak Aktif di Admin';
                } else {
                    machineStatusInfoEl.style.display = 'none';
                }
            }
            
            // Update downtime description
            if (downtimeDescEl) {
                if (!isAktif) {
                    // Jika Machine Tidak Aktif, jangan tampilkan downtime description
                    downtimeDescEl.style.display = 'none';
                } else if (data.HasActiveDowntime && data.ActiveDowntimeDescription) {
                    downtimeDescEl.textContent = data.ActiveDowntimeDescription;
                    downtimeDescEl.style.display = 'block';
                } else {
                    downtimeDescEl.style.display = 'none';
                }
            }
            
            // ‚úÖ PERBAIKAN: Update action buttons dengan data yang lengkap
            // setupFormHandlers() sudah dipanggil di dalam updateActionButtons()
            updateActionButtons({
                MachineStatus: machineStatusFromAdmin,
                HasActiveJob: hasActiveJob,
                HasActiveDowntime: hasActiveDowntime
            });
        }
        
        // Update action buttons - hanya update disabled state, biarkan browser handle form submission natural
        function updateActionButtons(data) {
            const btnRunning = document.getElementById('btn-running');
            const btnRest = document.getElementById('btn-rest');
            const btnLineStop = document.getElementById('btn-line-stop');
            
            // ‚úÖ PERBAIKAN: SELALU gunakan MachineStatus dari Admin dengan normalized value
            const machineStatusFromAdmin = (data.MachineStatus || '').toString().trim();
            const isDisabledByAdmin = machineStatusFromAdmin === 'TidakAktif';
            
            // ‚úÖ PERBAIKAN: Pastikan HasActiveJob dan HasActiveDowntime ada
            const hasActiveJobValue = data.HasActiveJob || false;
            const hasActiveDowntimeValue = data.HasActiveDowntime || false;
            
            console.log('üîò Updating action buttons:', {
                machineStatusFromAdmin,
                isDisabledByAdmin,
                hasActiveJob: hasActiveJobValue,
                hasActiveDowntime: hasActiveDowntimeValue
            });
            
            // RUNNING: Disabled jika machine tidak aktif, atau jika ada job aktif TANPA downtime (running)
            // Button RUNNING enabled jika:
            // - Machine aktif DAN (tidak ada job aktif ATAU ada downtime aktif yang bisa di-end)
            // Button RUNNING disabled jika:
            // - Machine tidak aktif ATAU (ada job aktif DAN tidak ada downtime aktif)
            if (btnRunning) {
                // ‚úÖ PERBAIKAN: Button disabled jika machine tidak aktif ATAU (ada job aktif TANPA downtime)
                // Jika ada downtime aktif, button enabled karena backend akan auto-end downtime saat diklik
                const shouldDisable = isDisabledByAdmin || (hasActiveJobValue && !hasActiveDowntimeValue);
                if (shouldDisable) {
                    btnRunning.disabled = true;
                    btnRunning.setAttribute('disabled', 'disabled');
                    btnRunning.style.pointerEvents = 'none';
                    btnRunning.style.cursor = 'not-allowed';
                    btnRunning.style.opacity = '0.6';
                    console.log('‚ùå RUNNING button DISABLED:', {
                        reason: isDisabledByAdmin ? 'Machine tidak aktif' : 'Machine sedang running (ada job aktif tanpa downtime)',
                        isDisabledByAdmin,
                        hasActiveJob: hasActiveJobValue,
                        hasActiveDowntime: hasActiveDowntimeValue
                    });
                } else {
                    // ‚úÖ PERBAIKAN: Force enable button dengan multiple methods
                    btnRunning.disabled = false;
                    btnRunning.removeAttribute('disabled');
                    btnRunning.style.pointerEvents = 'auto';
                    btnRunning.style.cursor = 'pointer';
                    btnRunning.style.opacity = '1';
                    
                    // ‚úÖ PERBAIKAN: Pastikan form juga bisa di-submit
                    const runningForm = document.getElementById('running-form');
                    if (runningForm) {
                        // Remove any blocking handlers
                        runningForm.onsubmit = null;
                        // Ensure form can submit naturally
                        console.log('‚úÖ RUNNING button ENABLED:', {
                            reason: !hasActiveJobValue ? 'Tidak ada job aktif - bisa start job baru' : 'Ada downtime aktif - backend akan auto-end downtime',
                            isDisabledByAdmin,
                            hasActiveJob: hasActiveJobValue,
                            hasActiveDowntime: hasActiveDowntimeValue
                        });
                    }
                }
            }
            
            // ISTIRAHAT: Disabled jika machine tidak aktif, TIDAK ada job aktif, atau SUDAH ada downtime aktif
            // Button ISTIRAHAT enabled jika:
            // - Machine aktif DAN ada job aktif DAN tidak ada downtime aktif (untuk start downtime)
            // Button ISTIRAHAT disabled jika:
            // - Machine tidak aktif ATAU tidak ada job aktif ATAU sudah ada downtime aktif
            if (btnRest) {
                // ‚úÖ PERBAIKAN: Button disabled jika machine tidak aktif, TIDAK ada job aktif, atau SUDAH ada downtime aktif
                const shouldDisable = isDisabledByAdmin || !hasActiveJobValue || hasActiveDowntimeValue;
                if (shouldDisable) {
                    btnRest.disabled = true;
                    btnRest.setAttribute('disabled', 'disabled');
                    btnRest.style.pointerEvents = 'none';
                    btnRest.style.cursor = 'not-allowed';
                    btnRest.style.opacity = '0.6';
                    console.log('‚ùå REST button DISABLED:', {
                        reason: isDisabledByAdmin ? 'Machine tidak aktif' : 
                                !hasActiveJobValue ? 'Tidak ada job aktif' : 
                                'Sudah ada downtime aktif',
                        isDisabledByAdmin,
                        hasActiveJob: hasActiveJobValue,
                        hasActiveDowntime: hasActiveDowntimeValue
                    });
                } else {
                    btnRest.disabled = false;
                    btnRest.removeAttribute('disabled');
                    btnRest.style.pointerEvents = 'auto';
                    btnRest.style.cursor = 'pointer';
                    btnRest.style.opacity = '1';
                    
                    // ‚úÖ PERBAIKAN: Pastikan form bisa di-submit
                    const restForm = document.getElementById('rest-form');
                    if (restForm) {
                        restForm.onsubmit = null;
                    }
                    console.log('‚úÖ REST button ENABLED:', {
                        reason: 'Ada job aktif dan tidak ada downtime aktif - bisa start downtime',
                        isDisabledByAdmin,
                        hasActiveJob: hasActiveJobValue,
                        hasActiveDowntime: hasActiveDowntimeValue
                    });
                }
            }
            
            // LINE STOP: Disabled jika machine tidak aktif, TIDAK ada job aktif, atau SUDAH ada downtime aktif
            // Button LINE STOP enabled jika:
            // - Machine aktif DAN ada job aktif DAN tidak ada downtime aktif (untuk start downtime)
            // Button LINE STOP disabled jika:
            // - Machine tidak aktif ATAU tidak ada job aktif ATAU sudah ada downtime aktif
            if (btnLineStop) {
                // ‚úÖ PERBAIKAN: Button disabled jika machine tidak aktif, TIDAK ada job aktif, atau SUDAH ada downtime aktif
                const shouldDisable = isDisabledByAdmin || !hasActiveJobValue || hasActiveDowntimeValue;
                if (shouldDisable) {
                    btnLineStop.disabled = true;
                    btnLineStop.setAttribute('disabled', 'disabled');
                    btnLineStop.style.pointerEvents = 'none';
                    btnLineStop.style.cursor = 'not-allowed';
                    btnLineStop.style.opacity = '0.6';
                    console.log('‚ùå LINE STOP button DISABLED:', {
                        reason: isDisabledByAdmin ? 'Machine tidak aktif' : 
                                !hasActiveJobValue ? 'Tidak ada job aktif' : 
                                'Sudah ada downtime aktif',
                        isDisabledByAdmin,
                        hasActiveJob: hasActiveJobValue,
                        hasActiveDowntime: hasActiveDowntimeValue
                    });
                } else {
                    btnLineStop.disabled = false;
                    btnLineStop.removeAttribute('disabled');
                    btnLineStop.style.pointerEvents = 'auto';
                    btnLineStop.style.cursor = 'pointer';
                    btnLineStop.style.opacity = '1';
                    console.log('‚úÖ LINE STOP button ENABLED:', {
                        reason: 'Ada job aktif dan tidak ada downtime aktif - bisa start downtime',
                        isDisabledByAdmin,
                        hasActiveJob: hasActiveJobValue,
                        hasActiveDowntime: hasActiveDowntimeValue
                    });
                }
            }
            
            // ‚úÖ PERBAIKAN: Setup form handlers SETELAH button state di-update
            // Ini memastikan button di form yang baru juga memiliki state yang benar
            // TAPI hanya setup sekali untuk menghindari duplicate handlers
            if (!formHandlersSetup) {
                setupFormHandlers();
                formHandlersSetup = true;
            } else {
                // Jika sudah setup, hanya sync button state tanpa clone form
                syncFormButtonStates();
            }
        }
        
        // ‚úÖ PERBAIKAN: Sync button states tanpa clone form (untuk menghindari duplicate handlers)
        function syncFormButtonStates() {
            // Sync RUNNING button
            const runningForm = document.getElementById('running-form');
            if (runningForm) {
                const formButton = runningForm.querySelector('button[type="submit"]');
                if (formButton && formButton.id === 'btn-running') {
                    const btnRunning = document.getElementById('btn-running');
                    if (btnRunning) {
                        if (!btnRunning.disabled) {
                            formButton.disabled = false;
                            formButton.removeAttribute('disabled');
                            formButton.style.pointerEvents = 'auto';
                            formButton.style.cursor = 'pointer';
                            formButton.style.opacity = '1';
                        } else {
                            formButton.disabled = true;
                            formButton.setAttribute('disabled', 'disabled');
                            formButton.style.pointerEvents = 'none';
                            formButton.style.cursor = 'not-allowed';
                            formButton.style.opacity = '0.6';
                        }
                    }
                }
            }
            
            // Sync REST button
            const restForm = document.getElementById('rest-form');
            if (restForm) {
                const formButton = restForm.querySelector('button[type="submit"]');
                if (formButton && formButton.id === 'btn-rest') {
                    const btnRest = document.getElementById('btn-rest');
                    if (btnRest) {
                        if (!btnRest.disabled) {
                            formButton.disabled = false;
                            formButton.removeAttribute('disabled');
                            formButton.style.pointerEvents = 'auto';
                            formButton.style.cursor = 'pointer';
                            formButton.style.opacity = '1';
                        } else {
                            formButton.disabled = true;
                            formButton.setAttribute('disabled', 'disabled');
                            formButton.style.pointerEvents = 'none';
                            formButton.style.cursor = 'not-allowed';
                            formButton.style.opacity = '0.6';
                        }
                    }
                }
            }
        }
        
        // ‚úÖ PERBAIKAN: Setup form submission handlers untuk reset timer saat actions berubah
        function setupFormHandlers() {
            // RUNNING form handler
            const runningForm = document.getElementById('running-form');
            if (runningForm) {
                // Remove existing handlers by cloning
                const newForm = runningForm.cloneNode(true);
                runningForm.parentNode.replaceChild(newForm, runningForm);
                
                // ‚úÖ PERBAIKAN: Pastikan button di form yang baru juga enabled sesuai dengan button utama
                const newRunningForm = document.getElementById('running-form');
                if (newRunningForm) {
                    const formButton = newRunningForm.querySelector('button[type="submit"]');
                    if (formButton && formButton.id === 'btn-running') {
                        // ‚úÖ PERBAIKAN: Copy state dari button utama ke button di form
                        const btnRunning = document.getElementById('btn-running');
                        if (btnRunning) {
                            if (!btnRunning.disabled) {
                                formButton.disabled = false;
                                formButton.removeAttribute('disabled');
                                formButton.style.pointerEvents = 'auto';
                                formButton.style.cursor = 'pointer';
                                formButton.style.opacity = '1';
                                console.log('‚úÖ Form button enabled after clone');
                            } else {
                                formButton.disabled = true;
                                formButton.setAttribute('disabled', 'disabled');
                                formButton.style.pointerEvents = 'none';
                                formButton.style.cursor = 'not-allowed';
                                formButton.style.opacity = '0.6';
                            }
                        }
                    }
                    
                    // Add new handler to reset timer on submit
                    newRunningForm.addEventListener('submit', function(e) {
                        console.log('üîÑ RUNNING form submitted - resetting timer');
                        // ‚úÖ PERBAIKAN: Set flag untuk skip timer update
                        skipTimerUpdate = true;
                        timerResetTime = new Date();
                        updateSinceLastChange(0);
                        console.log('‚è±Ô∏è Timer reset to 00:00:00 (RUNNING form submitted)');
                        // Don't prevent default - allow form to submit naturally
                    });
                }
            }
            
            // REST form handler
            const restForm = document.getElementById('rest-form');
            if (restForm) {
                const newForm = restForm.cloneNode(true);
                restForm.parentNode.replaceChild(newForm, restForm);
                
                const newRestForm = document.getElementById('rest-form');
                if (newRestForm) {
                    // ‚úÖ PERBAIKAN: Pastikan button di form yang baru juga enabled
                    const formButton = newRestForm.querySelector('button[type="submit"]');
                    if (formButton && formButton.id === 'btn-rest') {
                        const btnRest = document.getElementById('btn-rest');
                        if (btnRest) {
                            if (!btnRest.disabled) {
                                formButton.disabled = false;
                                formButton.removeAttribute('disabled');
                                formButton.style.pointerEvents = 'auto';
                                formButton.style.cursor = 'pointer';
                                formButton.style.opacity = '1';
                                console.log('‚úÖ REST form button enabled after clone');
                            } else {
                                formButton.disabled = true;
                                formButton.setAttribute('disabled', 'disabled');
                                formButton.style.pointerEvents = 'none';
                                formButton.style.cursor = 'not-allowed';
                                formButton.style.opacity = '0.6';
                            }
                        }
                    }
                    
                    newRestForm.addEventListener('submit', function(e) {
                        console.log('üîÑ REST form submitted - resetting timer');
                        // ‚úÖ PERBAIKAN: Set flag untuk skip timer update
                        skipTimerUpdate = true;
                        timerResetTime = new Date();
                        updateSinceLastChange(0);
                        console.log('‚è±Ô∏è Timer reset to 00:00:00 (REST form submitted)');
                    });
                }
            }
            
            // LINE STOP form handler
            const lineStopForm = document.getElementById('line-stop-start-form');
            if (lineStopForm) {
                const newForm = lineStopForm.cloneNode(true);
                lineStopForm.parentNode.replaceChild(newForm, lineStopForm);
                
                const newLineStopForm = document.getElementById('line-stop-start-form');
                if (newLineStopForm) {
                    newLineStopForm.addEventListener('submit', function(e) {
                        console.log('üîÑ LINE STOP form submitted - resetting timer');
                        // ‚úÖ PERBAIKAN: Set flag untuk skip timer update
                        skipTimerUpdate = true;
                        timerResetTime = new Date();
                        updateSinceLastChange(0);
                        console.log('‚è±Ô∏è Timer reset to 00:00:00 (LINE STOP form submitted)');
                    });
                }
            }
        }

        // Update since last change timer (real-time countdown)
        let sinceLastChangeInterval = null;
        let lastChangeTimestamp = null; // Store the actual timestamp
        
        function updateSinceLastChange(initialTimeSeconds) {
            const sinceLastChangeEl = document.getElementById('since-last-change');
            if (!sinceLastChangeEl) return;
            
            // Clear existing interval
            if (sinceLastChangeInterval) {
                clearInterval(sinceLastChangeInterval);
            }
            
            // Calculate the timestamp when last change occurred
            // initialTimeSeconds is the duration in seconds since last change
            const now = new Date();
            lastChangeTimestamp = new Date(now.getTime() - (initialTimeSeconds * 1000));
            
            // Update immediately
            updateTimerDisplay();
            
            // Update every second
            sinceLastChangeInterval = setInterval(() => {
                updateTimerDisplay();
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const sinceLastChangeEl = document.getElementById('since-last-change');
            if (!sinceLastChangeEl || !lastChangeTimestamp) return;
            
            const now = new Date();
            const diffMs = now.getTime() - lastChangeTimestamp.getTime();
            const totalSeconds = Math.floor(diffMs / 1000);
            
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            sinceLastChangeEl.textContent = timeString;
        }

        // Fallback: periodic refresh jika SignalR tidak connected
        function startPeriodicRefresh() {
            // ‚úÖ PERBAIKAN: Jangan start multiple intervals
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            console.log('‚è∞ Starting periodic refresh (10s interval) as fallback');
            refreshInterval = setInterval(() => {
                // Cek apakah SignalR sudah connected
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    console.log('‚úÖ SignalR connected, stopping periodic refresh');
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                    return;
                }
                
                // Jika SignalR tidak connected, refresh data via AJAX
                console.log('üîÑ Periodic refresh (SignalR not connected)');
                refreshOperatorData();
            }, 10000); // 10 seconds
        }

            // Initialize when page loads
            document.addEventListener('DOMContentLoaded', function () {
                // Debug: Log initial state
                console.log('üîç Initial Model State:', {
                    MachineStatus: '@Model.MachineStatus.ToString()',
                    HasActiveJob: @(Model.HasActiveJob.ToString().ToLower()),
                    HasActiveDowntime: @(Model.HasActiveDowntime.ToString().ToLower())
                });
                
            // ‚úÖ PERBAIKAN: Initialize button states based on current model state
            // Pastikan menggunakan MachineStatus dari Model (bukan calculated status)
            const initialData = {
                HasActiveJob: @(Model.HasActiveJob.ToString().ToLower()),
                HasActiveDowntime: @(Model.HasActiveDowntime.ToString().ToLower()),
                ActiveDowntimeDescription: '@Html.Raw(Model.ActiveDowntimeDescription ?? "")',
                MachineStatus: '@Model.MachineStatus.ToString()', // ‚úÖ SELALU gunakan dari Model
                Status: '@(Model.MachineStatus == MachineStatus.Aktif ? "AKTIF" : "TIDAK AKTIF")'
            };
            
            console.log('üîç Initial Data for Status Update:', initialData);
            
            // ‚úÖ PERBAIKAN: Reset flag form handlers untuk memastikan setup di awal
            formHandlersSetup = false;
            
            // ‚úÖ PERBAIKAN: Update status display dengan initial data terlebih dahulu
            // Ini memastikan status sinkron dengan data dari server saat initial load
            updateStatus(initialData);
            
            // Update button states berdasarkan data real-time
            updateActionButtons(initialData);
            
            // Load initial data (akan trigger updateStatus lagi dengan data fresh dari API)
            // Note: setupFormHandlers sudah dipanggil di updateActionButtons dan refreshOperatorData
            refreshOperatorData();
            
            // ‚úÖ PERBAIKAN: Pastikan button state di-update setelah refreshOperatorData selesai
            // Tambahkan delay untuk memastikan DOM sudah ready dan data sudah ter-load
            setTimeout(() => {
                console.log('üîÑ Re-checking button states after initial load...');
                refreshOperatorData();
            }, 1500);
            
            // Start timer immediately with initial value from server
            const initialTimeString = document.getElementById('since-last-change').textContent.trim();
            if (initialTimeString) {
                // Parse initial time from server (format: HH:mm:ss)
                const parts = initialTimeString.split(':');
                if (parts.length === 3) {
                    const initialSeconds = parseInt(parts[0]) * 3600 + 
                                         parseInt(parts[1]) * 60 + 
                                         parseInt(parts[2]);
                    updateSinceLastChange(initialSeconds);
                }
            }
            
            initializeSignalR();
            
            // Initial refresh after 2 seconds
            setTimeout(() => {
                refreshOperatorData();
            }, 2000);
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (connection) {
                    connection.stop();
                }
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
                if (sinceLastChangeInterval) {
                    clearInterval(sinceLastChangeInterval);
                }
            });
        });
    </script>
}

